# 响应式的基本原理

Vue 最独特的特性之一，是其非侵入性的响应式系统。数据模型仅仅是普通的 JavaScript 对象。而当你修改它们时，视图会进行更新。这使得状态管理非常直接，不过理解其工作原理同样重要，这样你可以避开一些常见的问题。

## 如何追踪变化

当你把一个普通的 JavaScript 对象传入 Vue 实例作为 `data` 选项，Vue 将遍历此对象所有的属性，并使用 [Object.defineProperty](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty) 把这些属性全部转为 [getter/setter](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Working_with_Objects#%E5%AE%9A%E4%B9%89_getters_%E4%B8%8E_setters)。`Object.defineProperty` 是 ES5 中一个无法 shim 的特性，这也就是 Vue 不支持 IE8 以及更低版本浏览器的原因。

这些 getter/setter 对用户来说是不可见的，但是在内部它们让 Vue 能够追踪依赖，在属性被访问和修改时通知变更。这里需要注意的是不同浏览器在控制台打印数据对象时对 getter/setter 的格式化会不相同。

每个组件实例都对应一个 Watcher 实例，它会在组件**渲染的过程中**把“接触”过的数据属性记录为依赖。之后当依赖项的 setter 触发时，会通知 watcher，从而使它关联的组件重新渲染。

<img src="../images/Vue responsive principle.png" width="500">

## 实现 observe

现在一个对象为例

首先我们定义一个 `cb` 函数，这个函数用来模拟视图更新，调用它即代表更新视图，内部可以是一些更新视图的方法。

```
function cb(val) {
  // 渲染视图
  console.log('视图更新啦...');
}
```

接着我们定义一个 `defineReactive` ，这个方法通过 `Object.defineProperty` 来实现对对象的**响应式**化。经过 `defineReactive` 处理以后，我们的 obj 的 key 属性在**读**的时候会触发 `reactiveGetter` 方法，而在该属性被**写**的时候则会触发`reactiveSetter` 方法。

```
/**
 * 对象响应化
 * @param {Object} obj 需要绑定的对象
 * @param {String} key 对象的属性
 * @param {*} val 属性的值
 */
function defineReactive(obj, key, val) {
  Object.defineProperty(obj, key, {
    enumerable: true, // 可枚举
    configurable: true, // 可修改或删除
    get: function reactiveGetter() {
      return val; // 实际上在这里会进行依赖收集
    },
    set: function reactiveSetter() {
      if (newVal === val) return;
      cb(newVal);
    }
  })
}
```

当然，这还不够，我们需要在上面再封装一层 `observer`。这个函数传入一个 value，通过遍历对象的所有属性的方式对该对象的每一个属性都通过 `defineReactive` 处理。

注：实际上 observer 会进行递归调用，这里省略了递归的过程。

```
/**
 * 对对象的每个属性响应化
 * @param {Object} value
 */
function observer(value) {
  if (!value || (typeof value !== 'object')) return;

  Object.keys(value).forEach((key) => {
    defineReactive(value, key, value[key]);
  });
}
```

最后，让我们用 `observer` 来封装一个 Vue 吧！

在 Vue 的构造函数中，对 `options` 的 `data` 进行处理，这里的 `data` 就是平时我们在写 Vue 项目时组件中的 `data` 属性（实际上是一个函数，这里当作一个对象来处理）。

```
class Vue {
  constructor(options) {
    this._data = options.data;
    observer(this._data);
  }
}
```

这里我们只要 new 一个 Vue 对象，就会将 data 中的数据进行**响应化**。如果我们对 `data` 的属性进行下面的操作，就会触发 `cb` 方法更新视图。

```
let o = new Vue({
  data: {
    test: 'This is a test'
  }
});
o._data.test = 'hello world'; // 视图更新啦...
```
